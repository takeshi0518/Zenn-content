---
title: 'Next.jsのハイドレーションエラーを時計機能で理解する'
emoji: '⏰️'
type: 'tech'
topics: ['nextjs', 'react', 'typescript', '初心者']
published: false
---

# はじめに

Next.js で時計機能を実装したとき、ハイドレーションエラーに遭遇しました。  
この記事では、そのエラーの原因を深堀りし、Next.js の内部構造を理解していきます。

同じようなエラーで悩んでいる方の参考になれば幸いです。

# エラーが発生した状況

## 発生したコード

天気情報アプリを作成していて、現在時刻を表示する時計機能を実装しました。

**LiveTime.tsx(エラーが発生したコード)**

```tsx
'use client';

import { useEffect, useState } from 'react';
import { formatDateToLocal, formatTimeToLocal } from '@/lib/utils';

export default function LiveTime() {
  const [currentTime, setCurrentTime] = useState(Date.now());

  useEffect(() => {
    const timer = setInterval(() => {
      setCurrentTime(Date.now());
    }, 1000);

    return () => clearInterval(timer);
  }, []);
  return (
    <div className="bg-white rounded-lg shadow-sm p-6 border border-gray-200 xl:flex-1">
      <div className="space-y-2">
        <div className="text-2xl md:text-3xl text-gray-900">
          {formatTimeToLocal(currentTime)}
        </div>
        <div className="text-3xl md:text-4xl text-gray-600">
          {formatDateToLocal(currentTime)}
        </div>
      </div>
    </div>
  );
}
```

**Heading.tsx(親コンポーネント)**

```tsx
'use client';

import SearchForm from './SearchForm';
import LiveTime from './LiveTime';

interface HeadingProps {
  onSearch: (city: string) => void;
}

export default function Heading({ onSearch }: HeadingProps) {
  return (
    <section className="space-y-6 lg:space-y-0 xl:flex xl:items-center xl:justify-between xl:gap-6">
      <LiveTime />
      <SearchForm onSearch={onSearch} />
    </section>
  );
}
```

一見問題なさそうに見えますが、このコードを実行するとエラーが発生。

## 発生したエラーメッセージ

開発サーバーを起動すると、コンソールに以下のようなエラーが表示されていました。

![ハイドレーションエラーのスクリーンショット](/images/hydration-error.png)

真っ赤なエラーに戸惑いましたが、冷静に読み解くと

```
Uncaught Error: Hydration failed because the server rendered text didn't match the client.
```

意味は「サーバーでレンダリングされたテキストとクライアントが一致しなかったため、ハイドレーションに失敗した」

さらに詳しく見ると、HTML の差分が表示されていました。

```
<div className="bg-white r...">
  <div className="space-y-2">
    <div className="text-2xl md:text-3xl text-gray-900">
+      01:13:51
-      01:13:50
```

`+`と`-`は、サーバーとクライアントで異なる値が生成されたことを示しています。  
つまり:

- サーバー側: `01:13:50`
- クライアント側: `01:13:51`

わずか 1 秒のズレですが、これが原因でエラーになっていた。  
なぜ同じコードなのに、サーバーとクライアントで違う値が生成されるのか？

# なぜエラーが起きたのか？

エラーの原因を理解するには、Next.js の SSR とハイドレーションの仕組みを知る必要があります。

## Next.js の SSR とは？

SSR とは`Server-side Rendering`の略です。
その名の通り、サーバーサイドでレンダリングすることを指します。  
注意点として、Next.js では**Client Component(`use client`がついたコンポーネント)も初回アクセス時はサーバー側でレンダリングされます。**
多くの初学者はこの点を勘違いをしていると思います。  
もちろん僕も勘違いをしていました。

Next.js では、ページがリクエストされると：

1. **サーバー側で React コンポーネントを実行**
2. **サーバー側で HTML を生成**
3. **生成された HTML をブラウザに返却**

この仕組みにより、ユーザーは素早くページの内容を見ることができます。
しかし、この時点ではまだ**静的な HTML**なので、ボタンクリックなどのインタラクティブな機能は動きません。また、`window`や`document`などのブラウザ API にもアクセスできません。  
ここで登場するのが「ハイドレーション」です。

## ハイドレーションとは？

ハイドレーション(Hydration)とは、**サーバーで生成された静的な HTML を表示した後、JavaScript をダウンロードして実行するというプロセスです。**

具体的な流れ:

1. **HTML を表示** - サーバーから受け取った HTML を表示
2. **JavaScript をダウンロード** - コンポーネントのコードがブラウザにダウンロードされる。
3. **JavaScript を実行** - React がコンポーネントを再実行
4. **DOM に紐づけ** - 既存の HTML にイベントリスナーや状態管理を紐付ける

この時、**サーバーで生成された HTML と、クライアントで実行された React の結果が一致している必要があります。**  
もし一致しなければ、ハイドレーションエラーが発生します。  
では、先程の`LiveTime`コンポーネントで何が起きていたのでしょうか？

## 時刻のズレが問題になる理由

ここまでの知識を踏まえて、先ほどのコードでなにが起きていたのか見ていきます。

**問題のコード**

```tsx
//LiveTimer.tsx
const [currentTime, setCurrentTime] = useState(Date.now());
```

### エラーが起きるまでの流れ

**1. サーバー側でのレンダリング(SSR)**

`LiveTime`コンポーネントがサーバーで実行されます。

```tsx
const [currentTime, setCurrentTime] = useState(Date.now());
//Date.now()が実行される → 例: 732374830000 (01:13:50)
```

このタイムスタンプを元に HTML が生成されます:

```html
01:13:50
```

**2. クライアント側でのハイドレーション**

ブラウザが HTML を受け取り、JavaScript をダウンロードして実行します。

再度`LiveTime`コンポーネントが実行される:

```tsx
const [currentTime, setCurrentTime] = useState(Date.now());
//Date.now()がまた実行される → 例: 1732374831000 (01:13:51)
```

サーバーでの実行から数秒経過しているため、**時刻が異なります**。

**3. React/Next.js の比較**

ハイドレーション時、React は以下を比較します:

```
サーバーが生成したHTML: <div>01:13:50</div>
クライアントが生成したHTML: <div>01:13:51</div>
```

**一致しない！** → ハイドレーションエラーが発生

`Date.now()`は**実行された瞬間の時刻**を返します。

- サーバーでの実行: 2025 年 11 月 24 日 01:13:50
- クライアントでの実行: 2025 年 11 月 24 日 01:13:51(わずか 1 秒後)

この**実行タイミングの違い**が、ハイドレーションエラーの原因でした。

React/Next.js は、サーバーとクライアントで同じ結果を期待していますが、`Date.now()`のような実行ごとに変わる値を使うと、この期待が裏切られてしまいます。

# 解決方法

## 方法 1:

## 方法 2:

## 方法 3:

# 学びと応用

## この経験から理解できたこと

## 他にもハイドレーションが起きるケース

# まとめ

# 参考にした記事

https://zenn.dev/noko_noko/articles/7987456909978c

https://zenn.dev/luvmini511/articles/71f65df05716ca

https://zenn.dev/ak/articles/dd60f8b1712628
